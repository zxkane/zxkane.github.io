<!doctype html><html lang=en-us><head><title>Effective AWS CDK for AWS CloudFormation</title><style>body,body.pushable{background-repeat:no-repeat;background-attachment:fixed;background-size:cover!important}</style><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=author content="Kane"><meta name=description content="Effectively write AWS CDK application then deploy it via AWS CloudFormation across multiple regions"><meta name=generator content="Hugo 0.78.1"><link rel="shortcut icon" href=/img/favicon.ico><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css><script src=https://code.jquery.com/jquery-3.3.1.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js></script><link href="https://fonts.googleapis.com/css?family=Abril+Fatface|Inconsolata" rel=stylesheet><link rel=stylesheet type=text/css href=/css/site.css><link rel=stylesheet type=text/css href=/css/highlight.css><link rel=stylesheet type=text/css href=/css/highlight.css><style>body.pushable{display:block;background-image:var(--bgImage)!important}</style><script>var isMobile=(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent))
console.log("The client device is a "+(isMobile?"mobile":"PC")+".")</script></head><body><script>var prevBgIndex=0;var bodyBgSwitchIndex=0;var gradients=[[],['#40e0d0','#ff8c00','#ff0080'],['#3e5151','#decba4'],['#11998e','#38ef7d'],['#108dc7','#ef8e38'],['#fc5c7d','#6a82fb'],['#fc466b','#3f5efb'],['#c94b4b','#4b134f'],['#23074d','#cc5333']];var randomBgColor=gradients[getRandomInt(0,gradients.length)].join(", ");var backgroundProperty='linear-gradient(to right, '+randomBgColor+')';document.body.style.background=backgroundProperty;function getRandomInt(min,max){min=Math.ceil(min);max=Math.floor(max);var random;while(1){random=Math.floor(Math.random()*(max-min))+min;if(random!==prevBgIndex){prevBgIndex=random;break;}}
return random;}</script><div id=sidebar class="ui sidebar inverted vertical menu"><section id=author class="ui top attached center aligned inverted segment"><div class="ui small circular image"><img src=/img/portrait.jpg></div><h3 class="ui header">Kane<div class="sub header">Three boys' father, open source mania.</div></h3></section><section class="ui attached center aligned inverted segment sidebar-dream-tags"><a class="ui label purple" href=/tags/aws title=aws>aws</a>
<a class="ui label purple" href=/tags/eclipse title=eclipse>eclipse</a>
<a class="ui label olive" href=/tags/%E4%BA%91%E8%AE%A1%E7%AE%97 title=äº‘è®¡ç®—>äº‘è®¡ç®—</a>
<a class="ui label orange" href=/tags/equinox title=equinox>equinox</a>
<a class="ui label teal" href=/tags/tip title=tip>tip</a>
<a class="ui label violet" href=/tags/osgi title=osgi>osgi</a>
<a class="ui label olive" href=/tags/p2 title=p2>p2</a>
<a class="ui label yellow" href=/tags/%E9%98%BF%E9%87%8C%E4%BA%91 title=é˜¿é‡Œäº‘>é˜¿é‡Œäº‘</a>
<a class="ui label purple" href=/tags/docker title=docker>docker</a>
<a class="ui label green" href=/tags/faas title=faas>faas</a></section><section class="ui attached inverted segment sidebar-dream-categories both flexbox"><div class="ui inverted accordion"><div class=title><i class="dropdown icon"></i><a class=link href=/categories/amazon-builders-library>amazon-builders-library</a></div><div class=content><a class=item href=https://kane.mx/posts/2020/the-best-practise-of-deployment-at-amazon/><div><i class="cocktail icon"></i><p>äºšé©¬é€Šçš„éƒ¨ç½²æœ€ä½³å®è·µ</p></div></a></div><div class=title><i class="dropdown icon"></i><a class=link href=/categories/blogging>blogging</a></div><div class=content><a class=item href=https://kane.mx/posts/2020/effective-aws-cdk-for-aws-cloudformation/><div><i class="cocktail icon"></i><p>Effective AWS CDK for AWS CloudFormation</p></div></a><a class=item href=https://kane.mx/posts/2020/the-best-practise-of-deployment-at-amazon/><div><i class="cocktail icon"></i><p>äºšé©¬é€Šçš„éƒ¨ç½²æœ€ä½³å®è·µ</p></div></a><a class=item href=https://kane.mx/posts/2020/deploy-aws-cdk-applications-cross-accounts/><div><i class="cocktail icon"></i><p>è·¨è´¦å·è·¨åŒºåŸŸéƒ¨ç½²AWS CDKç¼–æ’çš„åº”ç”¨</p></div></a><a class=item href=https://kane.mx/posts/2020/deploy-sonatype-nexus-oss-on-eks/><div><i class="cocktail icon"></i><p>Deploy Sonatype Nexus repository OSS on EKS</p></div></a><a class=item href=https://kane.mx/posts/2020/serverless-docker-images-analytics/><div><i class="cocktail icon"></i><p>æ— æœåŠ¡å™¨æ¶æ„çš„Dockeré•œåƒæ•°æ®åˆ†æåº”ç”¨</p></div></a><a class=item href=https://kane.mx/posts/2020/get-docker-image-size-without-pulling-image/><div><i class="cocktail icon"></i><p>Get the size of Docker image without pulling image</p></div></a><a class=item href=https://kane.mx/posts/2020/zsh-performance-tuning/><div><i class="cocktail icon"></i><p>oh-my-zshæ€§èƒ½è°ƒä¼˜æ€è·¯</p></div></a><a class=item href=https://kane.mx/posts/2020/codecommit-devops-model/><div><i class="cocktail icon"></i><p>åŸºäºCodeCommitä»£ç ç®¡ç†çš„æ— æœåŠ¡å™¨æ¶æ„Devops</p></div></a><a class=item href=https://kane.mx/posts/2020/new-http-apis-of-api-gateway/><div><i class="cocktail icon"></i><p>AWSå‘å¸ƒæ›´å¿«ã€æ›´ä¾¿å®œã€æ›´æ˜“ç”¨çš„HTTP APIs</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-cloud-debugging/><div><i class="cocktail icon"></i><p>AWS Cloud Debuggingåˆæ¢</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-batch/><div><i class="cocktail icon"></i><p>AWS Batchç®€ä»‹</p></div></a><a class=item href=https://kane.mx/posts/2019/email-forwarding/><div><i class="cocktail icon"></i><p>å…è´¹é‚®ä»¶è½¬å‘æœåŠ¡</p></div></a><a class=item href=https://kane.mx/posts/2019/aliyun-edas-migration-in-action/><div><i class="cocktail icon"></i><p>å®æˆ˜Aliyun EDASåº”ç”¨è¿ç§»AWS</p></div></a><a class=item href=https://kane.mx/posts/2019/rds-log-analysis/><div><i class="cocktail icon"></i><p>AWS RDSæ•°æ®åº“æ—¥å¿—åˆ†æåŠå±•ç¤º</p></div></a><a class=item href=https://kane.mx/posts/2019/using-openswan-connect-aws-vpn/><div><i class="cocktail icon"></i><p>ä½¿ç”¨Openswanè¿æ¥AWS VPC</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-cdk/><div><i class="cocktail icon"></i><p>AWS CDKç®€ä»‹</p></div></a><a class=item href=https://kane.mx/posts/2019/alexa-login-issue/><div><i class="cocktail icon"></i><p>Amazon Alexa Androidç‰ˆæœ¬å›½å†…ç™»å½•é—®é¢˜</p></div></a><a class=item href=https://kane.mx/posts/2019/using-s3-as-device-for-mac-time-machine-backup/><div><i class="cocktail icon"></i><p>ä½¿ç”¨AWS S3ä½œä¸ºMacOSXæ—¶é—´æœºå™¨(Time Machine)çš„å¤‡ä»½å­˜å‚¨</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-vs-aliyun/><div><i class="cocktail icon"></i><p>å…¬æœ‰äº‘å¯¹æ¯”</p></div></a><a class=item href=https://kane.mx/posts/2019/serverless-framework/><div><i class="cocktail icon"></i><p>Serverless framework 101</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-lambda-layers/><div><i class="cocktail icon"></i><p>AWS Lambda Layerå®è·µ</p></div></a><a class=item href=https://kane.mx/posts/2019/2019-qconbeijing-reviews/><div><i class="cocktail icon"></i><p>QCon2019åŒ—äº¬ç«™å›é¡¾</p></div></a><a class=item href=https://kane.mx/posts/2018/2018-12-13-bj-archsummit-review/><div><i class="cocktail icon"></i><p>2018åŒ—äº¬ArchSummitå›é¡¾</p></div></a><a class=item href=https://kane.mx/posts/2016/how-to-fix-jenkins-fail-to-load-job-config/><div><i class="cocktail icon"></i><p>å¦‚ä½•ä¿®å¤Jenkins CIæ— æ³•è¯»å–å­˜åœ¨çš„ä»»åŠ¡é…ç½®</p></div></a><a class=item href=https://kane.mx/posts/2016/how-to-find-slow-queries-in-mongodb/><div><i class="cocktail icon"></i><p>MongoDBä¸­å¦‚ä½•æ‰¾å‡ºæ…¢æŸ¥è¯¢</p></div></a><a class=item href=https://kane.mx/posts/2016/the-limitations-docker-swarm-mode-v1.12/><div><i class="cocktail icon"></i><p>Docker Swarm mode(v1.12.x)çš„ä¸€äº›ä½¿ç”¨é™åˆ¶</p></div></a><a class=item href=https://kane.mx/posts/2016/docker-swarm-mode-in-ubuntu-1404/><div><i class="cocktail icon"></i><p>åˆ›å»ºäºDocker Swarmçš„æœåŠ¡æ— æ³•åœ¨Ubuntu 14.04 LTSä¸­è¿è¡Œ</p></div></a><a class=item href=https://kane.mx/posts/2016/seo-optimization-for-angularajs-based-app/><div><i class="cocktail icon"></i><p>åŸºäºAngularjså•é¡µé¢åº”ç”¨çš„SEOä¼˜åŒ–</p></div></a><a class=item href=https://kane.mx/posts/2016/clustered-session-under-spring-framework/><div><i class="cocktail icon"></i><p>Springæ¡†æ¶ä¸‹çš„åˆ†å¸ƒå¼sessionç®¡ç†</p></div></a><a class=item href=https://kane.mx/posts/2016/how-we-build-videome/><div><i class="cocktail icon"></i><p>Vç§˜æ˜¯å¦‚ä½•æ„å»ºçš„</p></div></a><a class=item href=https://kane.mx/posts/2016/aliyun-ossfs-sucks/><div><i class="cocktail icon"></i><p>è¯´ä¸€è¯´é˜¿é‡Œäº‘ossfs</p></div></a><a class=item href=https://kane.mx/posts/2016/weixin-temporary-materials/><div><i class="cocktail icon"></i><p>å¦‚ä½•ä½¿ç”¨å¾®ä¿¡å…¬ä¼—å¹³å°çš„ä¸´æ—¶ç´ æ</p></div></a><a class=item href=https://kane.mx/posts/2016/single-page-app-meets-weixin-pay/><div><i class="cocktail icon"></i><p>å•é¡µé¢åº”ç”¨(single page application)ä¸­ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜</p></div></a><a class=item href=https://kane.mx/posts/2016/docker-build-no-space-left-caused-by-inode-exhausted/><div><i class="cocktail icon"></i><p>æ–‡ä»¶ç³»ç»Ÿçš„Inodeè€—å°½ï¼Œä¼šå¯¼è‡´Dockerç¼–è¯‘é•œåƒå‡ºç°'No space left on device'é”™è¯¯</p></div></a></div><div class=title><i class="dropdown icon"></i><a class=link href=/categories/effective-cloud-computing>effective-cloud-computing</a></div><div class=content><a class=item href=https://kane.mx/posts/2020/effective-aws-cdk-for-aws-cloudformation/><div><i class="cocktail icon"></i><p>Effective AWS CDK for AWS CloudFormation</p></div></a><a class=item href=https://kane.mx/posts/2020/deploy-aws-cdk-applications-cross-accounts/><div><i class="cocktail icon"></i><p>è·¨è´¦å·è·¨åŒºåŸŸéƒ¨ç½²AWS CDKç¼–æ’çš„åº”ç”¨</p></div></a><a class=item href=https://kane.mx/posts/2020/deploy-sonatype-nexus-oss-on-eks/><div><i class="cocktail icon"></i><p>Deploy Sonatype Nexus repository OSS on EKS</p></div></a><a class=item href=https://kane.mx/posts/2020/serverless-docker-images-analytics/><div><i class="cocktail icon"></i><p>æ— æœåŠ¡å™¨æ¶æ„çš„Dockeré•œåƒæ•°æ®åˆ†æåº”ç”¨</p></div></a><a class=item href=https://kane.mx/posts/2020/codecommit-devops-model/><div><i class="cocktail icon"></i><p>åŸºäºCodeCommitä»£ç ç®¡ç†çš„æ— æœåŠ¡å™¨æ¶æ„Devops</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-cloud-debugging/><div><i class="cocktail icon"></i><p>AWS Cloud Debuggingåˆæ¢</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-batch/><div><i class="cocktail icon"></i><p>AWS Batchç®€ä»‹</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-cdk/><div><i class="cocktail icon"></i><p>AWS CDKç®€ä»‹</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/serverless-domain-redirect/><div><i class="cocktail icon"></i><p>æ— æœåŠ¡å™¨æ¶æ„çš„åŸŸåé‡å®šå‘æœåŠ¡</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/spring-cloud-function-for-aws/><div><i class="cocktail icon"></i><p>Spring Cloud Function -- è·¨Serverlesså¹³å°çš„å‡½æ•°è®¡ç®—æ¡†æ¶</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/spring-cloud-or-cloud-native/><div><i class="cocktail icon"></i><p>Spring Cloud or Cloud Native</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/oauth2-proxy-on-kubernetes/part2/><div><i class="cocktail icon"></i><p>ä¸ºKubernetesä¸­ä»»æ„åº”ç”¨æ·»åŠ åŸºäºoauth2çš„è®¤è¯ä¿æŠ¤ (ä¸‹)</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/serverless-dingtalk-callback/><div><i class="cocktail icon"></i><p>åŸºäºå‡½æ•°è®¡ç®—çš„é’‰é’‰å›è°ƒå‡½æ•°æ¥å£</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/serverless-computing-101/><div><i class="cocktail icon"></i><p>æ— æœåŠ¡å™¨è®¡ç®—101</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/oauth2-proxy-on-kubernetes/part1/><div><i class="cocktail icon"></i><p>ä¸ºKubernetesä¸­ä»»æ„åº”ç”¨æ·»åŠ åŸºäºoauth2çš„è®¤è¯ä¿æŠ¤ (ä¸Š)</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/iam-best-practice/><div><i class="cocktail icon"></i><p>IAMæœ€ä½³å®è·µ</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/using-kubernetes-on-cloud/><div><i class="cocktail icon"></i><p>ä¸è¦è‡ªå»ºKubernetes</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/preface/><div><i class="cocktail icon"></i><p>çœŸçš„ä¼šç”¨äº‘æœåŠ¡å—ï¼Ÿ</p></div></a></div><div class=title><i class="dropdown icon"></i><a class=link href=/categories/kubernetes>kubernetes</a></div><div class=content><a class=item href=https://kane.mx/posts/effective-cloud-computing/spring-cloud-or-cloud-native/><div><i class="cocktail icon"></i><p>Spring Cloud or Cloud Native</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/oauth2-proxy-on-kubernetes/part2/><div><i class="cocktail icon"></i><p>ä¸ºKubernetesä¸­ä»»æ„åº”ç”¨æ·»åŠ åŸºäºoauth2çš„è®¤è¯ä¿æŠ¤ (ä¸‹)</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/oauth2-proxy-on-kubernetes/part1/><div><i class="cocktail icon"></i><p>ä¸ºKubernetesä¸­ä»»æ„åº”ç”¨æ·»åŠ åŸºäºoauth2çš„è®¤è¯ä¿æŠ¤ (ä¸Š)</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/using-kubernetes-on-cloud/><div><i class="cocktail icon"></i><p>ä¸è¦è‡ªå»ºKubernetes</p></div></a></div><div class=title><i class="dropdown icon"></i><a class=link href=/categories/serverless-computing>serverless-computing</a></div><div class=content><a class=item href=https://kane.mx/posts/2020/new-http-apis-of-api-gateway/><div><i class="cocktail icon"></i><p>AWSå‘å¸ƒæ›´å¿«ã€æ›´ä¾¿å®œã€æ›´æ˜“ç”¨çš„HTTP APIs</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/serverless-domain-redirect/><div><i class="cocktail icon"></i><p>æ— æœåŠ¡å™¨æ¶æ„çš„åŸŸåé‡å®šå‘æœåŠ¡</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/spring-cloud-function-for-aws/><div><i class="cocktail icon"></i><p>Spring Cloud Function -- è·¨Serverlesså¹³å°çš„å‡½æ•°è®¡ç®—æ¡†æ¶</p></div></a><a class=item href=https://kane.mx/posts/2019/serverless-framework/><div><i class="cocktail icon"></i><p>Serverless framework 101</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-lambda-layers/><div><i class="cocktail icon"></i><p>AWS Lambda Layerå®è·µ</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/serverless-dingtalk-callback/><div><i class="cocktail icon"></i><p>åŸºäºå‡½æ•°è®¡ç®—çš„é’‰é’‰å›è°ƒå‡½æ•°æ¥å£</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/serverless-computing-101/><div><i class="cocktail icon"></i><p>æ— æœåŠ¡å™¨è®¡ç®—101</p></div></a></div><div class=title><i class="dropdown icon"></i><a class=link href=/categories/trip>trip</a></div><div class=content><a class=item href=https://kane.mx/posts/archive/blogspot/food-and-drinking/><div><i class="cocktail icon"></i><p>Food and Drinking</p></div></a><a class=item href=https://kane.mx/posts/archive/blogspot/working-workspace/><div><i class="cocktail icon"></i><p>Working Workspace</p></div></a><a class=item href=https://kane.mx/posts/archive/blogspot/transportation/><div><i class="cocktail icon"></i><p>Transportation</p></div></a><a class=item href=https://kane.mx/posts/archive/blogspot/working-style/><div><i class="cocktail icon"></i><p>Working style</p></div></a><a class=item href=https://kane.mx/posts/archive/blogspot/day-1/><div><i class="cocktail icon"></i><p>day 1</p></div></a></div></div></section><section id=footer class="ui bottom attached center aligned inverted segment"><p>Â© 2021 The Road</p><p>Powered by <a href=https://gohugo.io/ target=_blank>Hugo</a> with <a href=https://github.com/UtkarshVerma/hugo-dream-plus target=_blank>Dream Plus</a> theme.</p></section></div><div class=pusher><div class=flipper><div class=front><nav class="ui top secondary menu bar"><div class=item><i class="inverted big link bullseye icon dream-flip-toggle" title="About Me"></i></div><div class=item><a href=/><i class="inverted big link home icon" title=Home></i></a></div><div class=item><a href=/tags><i class="inverted big link tags icon" title="All Tags"></i></a></div><div class=item><a href=/categories><i class="inverted big link cubes icon" title="All Categories"></i></a></div><div class="ui container tablet computer only grid"><div class=item onclick="$('.ui.sidebar').sidebar('setting','transition','overlay').sidebar('toggle');"><i class="inverted big link sidebar icon" title="Show Sidebar"></i></div></div><div class="item right"><a href=/posts/index.xml><i class="inverted big link rss icon" title="RSS Feed"></i></a></div></nav><div class="ui centered grid"><div class="sixteen wide mobile only column"><div class="ui inverted accordion"><div id=header class="ui inverted segment column box"><header id=author class="ui top attached center aligned inverted segment"><div class="ui small circular image"><img src=/img/portrait.jpg></div><h3 class="ui header">Kane<div class="sub header">Three boys' father, open source mania.</div></h3></header><div class="title header-title"><div id=tag-category-pop class="ui red right corner label"><i class="hand point icon down" title="Show/hide tags and categories"></i></div></div><div id=tag-category class=content><section class="ui attached center aligned inverted segment dream-tags none flexbox"><a class="ui label purple" href=/tags/aws title=aws>aws</a>
<a class="ui label violet" href=/tags/eclipse title=eclipse>eclipse</a>
<a class="ui label orange" href=/tags/%E4%BA%91%E8%AE%A1%E7%AE%97 title=äº‘è®¡ç®—>äº‘è®¡ç®—</a>
<a class="ui label red" href=/tags/equinox title=equinox>equinox</a>
<a class="ui label brown" href=/tags/tip title=tip>tip</a>
<a class="ui label purple" href=/tags/osgi title=osgi>osgi</a>
<a class="ui label red" href=/tags/p2 title=p2>p2</a>
<a class="ui label olive" href=/tags/%E9%98%BF%E9%87%8C%E4%BA%91 title=é˜¿é‡Œäº‘>é˜¿é‡Œäº‘</a>
<a class="ui label teal" href=/tags/docker title=docker>docker</a>
<a class="ui label brown" href=/tags/faas title=faas>faas</a></section><section class="ui attached inverted segment dream-categories both flexbox"><div class="inverted accordion"><div class=title><i class="dropdown icon"></i><a class=link href=/categories/amazon-builders-library>amazon-builders-library</a></div><div class=content><a class=item href=https://kane.mx/posts/2020/the-best-practise-of-deployment-at-amazon/><div><i class="cocktail icon"></i><p>äºšé©¬é€Šçš„éƒ¨ç½²æœ€ä½³å®è·µ</p></div></a></div><div class=title><i class="dropdown icon"></i><a class=link href=/categories/blogging>blogging</a></div><div class=content><a class=item href=https://kane.mx/posts/2020/effective-aws-cdk-for-aws-cloudformation/><div><i class="cocktail icon"></i><p>Effective AWS CDK for AWS CloudFormation</p></div></a><a class=item href=https://kane.mx/posts/2020/the-best-practise-of-deployment-at-amazon/><div><i class="cocktail icon"></i><p>äºšé©¬é€Šçš„éƒ¨ç½²æœ€ä½³å®è·µ</p></div></a><a class=item href=https://kane.mx/posts/2020/deploy-aws-cdk-applications-cross-accounts/><div><i class="cocktail icon"></i><p>è·¨è´¦å·è·¨åŒºåŸŸéƒ¨ç½²AWS CDKç¼–æ’çš„åº”ç”¨</p></div></a><a class=item href=https://kane.mx/posts/2020/deploy-sonatype-nexus-oss-on-eks/><div><i class="cocktail icon"></i><p>Deploy Sonatype Nexus repository OSS on EKS</p></div></a><a class=item href=https://kane.mx/posts/2020/serverless-docker-images-analytics/><div><i class="cocktail icon"></i><p>æ— æœåŠ¡å™¨æ¶æ„çš„Dockeré•œåƒæ•°æ®åˆ†æåº”ç”¨</p></div></a><a class=item href=https://kane.mx/posts/2020/get-docker-image-size-without-pulling-image/><div><i class="cocktail icon"></i><p>Get the size of Docker image without pulling image</p></div></a><a class=item href=https://kane.mx/posts/2020/zsh-performance-tuning/><div><i class="cocktail icon"></i><p>oh-my-zshæ€§èƒ½è°ƒä¼˜æ€è·¯</p></div></a><a class=item href=https://kane.mx/posts/2020/codecommit-devops-model/><div><i class="cocktail icon"></i><p>åŸºäºCodeCommitä»£ç ç®¡ç†çš„æ— æœåŠ¡å™¨æ¶æ„Devops</p></div></a><a class=item href=https://kane.mx/posts/2020/new-http-apis-of-api-gateway/><div><i class="cocktail icon"></i><p>AWSå‘å¸ƒæ›´å¿«ã€æ›´ä¾¿å®œã€æ›´æ˜“ç”¨çš„HTTP APIs</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-cloud-debugging/><div><i class="cocktail icon"></i><p>AWS Cloud Debuggingåˆæ¢</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-batch/><div><i class="cocktail icon"></i><p>AWS Batchç®€ä»‹</p></div></a><a class=item href=https://kane.mx/posts/2019/email-forwarding/><div><i class="cocktail icon"></i><p>å…è´¹é‚®ä»¶è½¬å‘æœåŠ¡</p></div></a><a class=item href=https://kane.mx/posts/2019/aliyun-edas-migration-in-action/><div><i class="cocktail icon"></i><p>å®æˆ˜Aliyun EDASåº”ç”¨è¿ç§»AWS</p></div></a><a class=item href=https://kane.mx/posts/2019/rds-log-analysis/><div><i class="cocktail icon"></i><p>AWS RDSæ•°æ®åº“æ—¥å¿—åˆ†æåŠå±•ç¤º</p></div></a><a class=item href=https://kane.mx/posts/2019/using-openswan-connect-aws-vpn/><div><i class="cocktail icon"></i><p>ä½¿ç”¨Openswanè¿æ¥AWS VPC</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-cdk/><div><i class="cocktail icon"></i><p>AWS CDKç®€ä»‹</p></div></a><a class=item href=https://kane.mx/posts/2019/alexa-login-issue/><div><i class="cocktail icon"></i><p>Amazon Alexa Androidç‰ˆæœ¬å›½å†…ç™»å½•é—®é¢˜</p></div></a><a class=item href=https://kane.mx/posts/2019/using-s3-as-device-for-mac-time-machine-backup/><div><i class="cocktail icon"></i><p>ä½¿ç”¨AWS S3ä½œä¸ºMacOSXæ—¶é—´æœºå™¨(Time Machine)çš„å¤‡ä»½å­˜å‚¨</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-vs-aliyun/><div><i class="cocktail icon"></i><p>å…¬æœ‰äº‘å¯¹æ¯”</p></div></a><a class=item href=https://kane.mx/posts/2019/serverless-framework/><div><i class="cocktail icon"></i><p>Serverless framework 101</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-lambda-layers/><div><i class="cocktail icon"></i><p>AWS Lambda Layerå®è·µ</p></div></a><a class=item href=https://kane.mx/posts/2019/2019-qconbeijing-reviews/><div><i class="cocktail icon"></i><p>QCon2019åŒ—äº¬ç«™å›é¡¾</p></div></a><a class=item href=https://kane.mx/posts/2018/2018-12-13-bj-archsummit-review/><div><i class="cocktail icon"></i><p>2018åŒ—äº¬ArchSummitå›é¡¾</p></div></a><a class=item href=https://kane.mx/posts/2016/how-to-fix-jenkins-fail-to-load-job-config/><div><i class="cocktail icon"></i><p>å¦‚ä½•ä¿®å¤Jenkins CIæ— æ³•è¯»å–å­˜åœ¨çš„ä»»åŠ¡é…ç½®</p></div></a><a class=item href=https://kane.mx/posts/2016/how-to-find-slow-queries-in-mongodb/><div><i class="cocktail icon"></i><p>MongoDBä¸­å¦‚ä½•æ‰¾å‡ºæ…¢æŸ¥è¯¢</p></div></a><a class=item href=https://kane.mx/posts/2016/the-limitations-docker-swarm-mode-v1.12/><div><i class="cocktail icon"></i><p>Docker Swarm mode(v1.12.x)çš„ä¸€äº›ä½¿ç”¨é™åˆ¶</p></div></a><a class=item href=https://kane.mx/posts/2016/docker-swarm-mode-in-ubuntu-1404/><div><i class="cocktail icon"></i><p>åˆ›å»ºäºDocker Swarmçš„æœåŠ¡æ— æ³•åœ¨Ubuntu 14.04 LTSä¸­è¿è¡Œ</p></div></a><a class=item href=https://kane.mx/posts/2016/seo-optimization-for-angularajs-based-app/><div><i class="cocktail icon"></i><p>åŸºäºAngularjså•é¡µé¢åº”ç”¨çš„SEOä¼˜åŒ–</p></div></a><a class=item href=https://kane.mx/posts/2016/clustered-session-under-spring-framework/><div><i class="cocktail icon"></i><p>Springæ¡†æ¶ä¸‹çš„åˆ†å¸ƒå¼sessionç®¡ç†</p></div></a><a class=item href=https://kane.mx/posts/2016/how-we-build-videome/><div><i class="cocktail icon"></i><p>Vç§˜æ˜¯å¦‚ä½•æ„å»ºçš„</p></div></a><a class=item href=https://kane.mx/posts/2016/aliyun-ossfs-sucks/><div><i class="cocktail icon"></i><p>è¯´ä¸€è¯´é˜¿é‡Œäº‘ossfs</p></div></a><a class=item href=https://kane.mx/posts/2016/weixin-temporary-materials/><div><i class="cocktail icon"></i><p>å¦‚ä½•ä½¿ç”¨å¾®ä¿¡å…¬ä¼—å¹³å°çš„ä¸´æ—¶ç´ æ</p></div></a><a class=item href=https://kane.mx/posts/2016/single-page-app-meets-weixin-pay/><div><i class="cocktail icon"></i><p>å•é¡µé¢åº”ç”¨(single page application)ä¸­ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜</p></div></a><a class=item href=https://kane.mx/posts/2016/docker-build-no-space-left-caused-by-inode-exhausted/><div><i class="cocktail icon"></i><p>æ–‡ä»¶ç³»ç»Ÿçš„Inodeè€—å°½ï¼Œä¼šå¯¼è‡´Dockerç¼–è¯‘é•œåƒå‡ºç°'No space left on device'é”™è¯¯</p></div></a></div><div class=title><i class="dropdown icon"></i><a class=link href=/categories/effective-cloud-computing>effective-cloud-computing</a></div><div class=content><a class=item href=https://kane.mx/posts/2020/effective-aws-cdk-for-aws-cloudformation/><div><i class="cocktail icon"></i><p>Effective AWS CDK for AWS CloudFormation</p></div></a><a class=item href=https://kane.mx/posts/2020/deploy-aws-cdk-applications-cross-accounts/><div><i class="cocktail icon"></i><p>è·¨è´¦å·è·¨åŒºåŸŸéƒ¨ç½²AWS CDKç¼–æ’çš„åº”ç”¨</p></div></a><a class=item href=https://kane.mx/posts/2020/deploy-sonatype-nexus-oss-on-eks/><div><i class="cocktail icon"></i><p>Deploy Sonatype Nexus repository OSS on EKS</p></div></a><a class=item href=https://kane.mx/posts/2020/serverless-docker-images-analytics/><div><i class="cocktail icon"></i><p>æ— æœåŠ¡å™¨æ¶æ„çš„Dockeré•œåƒæ•°æ®åˆ†æåº”ç”¨</p></div></a><a class=item href=https://kane.mx/posts/2020/codecommit-devops-model/><div><i class="cocktail icon"></i><p>åŸºäºCodeCommitä»£ç ç®¡ç†çš„æ— æœåŠ¡å™¨æ¶æ„Devops</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-cloud-debugging/><div><i class="cocktail icon"></i><p>AWS Cloud Debuggingåˆæ¢</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-batch/><div><i class="cocktail icon"></i><p>AWS Batchç®€ä»‹</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-cdk/><div><i class="cocktail icon"></i><p>AWS CDKç®€ä»‹</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/serverless-domain-redirect/><div><i class="cocktail icon"></i><p>æ— æœåŠ¡å™¨æ¶æ„çš„åŸŸåé‡å®šå‘æœåŠ¡</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/spring-cloud-function-for-aws/><div><i class="cocktail icon"></i><p>Spring Cloud Function -- è·¨Serverlesså¹³å°çš„å‡½æ•°è®¡ç®—æ¡†æ¶</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/spring-cloud-or-cloud-native/><div><i class="cocktail icon"></i><p>Spring Cloud or Cloud Native</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/oauth2-proxy-on-kubernetes/part2/><div><i class="cocktail icon"></i><p>ä¸ºKubernetesä¸­ä»»æ„åº”ç”¨æ·»åŠ åŸºäºoauth2çš„è®¤è¯ä¿æŠ¤ (ä¸‹)</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/serverless-dingtalk-callback/><div><i class="cocktail icon"></i><p>åŸºäºå‡½æ•°è®¡ç®—çš„é’‰é’‰å›è°ƒå‡½æ•°æ¥å£</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/serverless-computing-101/><div><i class="cocktail icon"></i><p>æ— æœåŠ¡å™¨è®¡ç®—101</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/oauth2-proxy-on-kubernetes/part1/><div><i class="cocktail icon"></i><p>ä¸ºKubernetesä¸­ä»»æ„åº”ç”¨æ·»åŠ åŸºäºoauth2çš„è®¤è¯ä¿æŠ¤ (ä¸Š)</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/iam-best-practice/><div><i class="cocktail icon"></i><p>IAMæœ€ä½³å®è·µ</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/using-kubernetes-on-cloud/><div><i class="cocktail icon"></i><p>ä¸è¦è‡ªå»ºKubernetes</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/preface/><div><i class="cocktail icon"></i><p>çœŸçš„ä¼šç”¨äº‘æœåŠ¡å—ï¼Ÿ</p></div></a></div><div class=title><i class="dropdown icon"></i><a class=link href=/categories/kubernetes>kubernetes</a></div><div class=content><a class=item href=https://kane.mx/posts/effective-cloud-computing/spring-cloud-or-cloud-native/><div><i class="cocktail icon"></i><p>Spring Cloud or Cloud Native</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/oauth2-proxy-on-kubernetes/part2/><div><i class="cocktail icon"></i><p>ä¸ºKubernetesä¸­ä»»æ„åº”ç”¨æ·»åŠ åŸºäºoauth2çš„è®¤è¯ä¿æŠ¤ (ä¸‹)</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/oauth2-proxy-on-kubernetes/part1/><div><i class="cocktail icon"></i><p>ä¸ºKubernetesä¸­ä»»æ„åº”ç”¨æ·»åŠ åŸºäºoauth2çš„è®¤è¯ä¿æŠ¤ (ä¸Š)</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/using-kubernetes-on-cloud/><div><i class="cocktail icon"></i><p>ä¸è¦è‡ªå»ºKubernetes</p></div></a></div><div class=title><i class="dropdown icon"></i><a class=link href=/categories/serverless-computing>serverless-computing</a></div><div class=content><a class=item href=https://kane.mx/posts/2020/new-http-apis-of-api-gateway/><div><i class="cocktail icon"></i><p>AWSå‘å¸ƒæ›´å¿«ã€æ›´ä¾¿å®œã€æ›´æ˜“ç”¨çš„HTTP APIs</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/serverless-domain-redirect/><div><i class="cocktail icon"></i><p>æ— æœåŠ¡å™¨æ¶æ„çš„åŸŸåé‡å®šå‘æœåŠ¡</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/spring-cloud-function-for-aws/><div><i class="cocktail icon"></i><p>Spring Cloud Function -- è·¨Serverlesså¹³å°çš„å‡½æ•°è®¡ç®—æ¡†æ¶</p></div></a><a class=item href=https://kane.mx/posts/2019/serverless-framework/><div><i class="cocktail icon"></i><p>Serverless framework 101</p></div></a><a class=item href=https://kane.mx/posts/2019/aws-lambda-layers/><div><i class="cocktail icon"></i><p>AWS Lambda Layerå®è·µ</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/serverless-dingtalk-callback/><div><i class="cocktail icon"></i><p>åŸºäºå‡½æ•°è®¡ç®—çš„é’‰é’‰å›è°ƒå‡½æ•°æ¥å£</p></div></a><a class=item href=https://kane.mx/posts/effective-cloud-computing/serverless-computing-101/><div><i class="cocktail icon"></i><p>æ— æœåŠ¡å™¨è®¡ç®—101</p></div></a></div><div class=title><i class="dropdown icon"></i><a class=link href=/categories/trip>trip</a></div><div class=content><a class=item href=https://kane.mx/posts/archive/blogspot/food-and-drinking/><div><i class="cocktail icon"></i><p>Food and Drinking</p></div></a><a class=item href=https://kane.mx/posts/archive/blogspot/working-workspace/><div><i class="cocktail icon"></i><p>Working Workspace</p></div></a><a class=item href=https://kane.mx/posts/archive/blogspot/transportation/><div><i class="cocktail icon"></i><p>Transportation</p></div></a><a class=item href=https://kane.mx/posts/archive/blogspot/working-style/><div><i class="cocktail icon"></i><p>Working style</p></div></a><a class=item href=https://kane.mx/posts/archive/blogspot/day-1/><div><i class="cocktail icon"></i><p>day 1</p></div></a></div></div></section></div><footer class="ui bottom attached center aligned inverted segment"><p>Â© 2021 The Road</p><p>Powered by <a href=https://gohugo.io/ target=_blank>Hugo</a> with <a href=https://github.com/UtkarshVerma/hugo-dream-plus target=_blank>Dream Plus</a> theme.</p></footer></div></div></div><div class="sixteen wide mobile fifteen wide tablet twelve wide computer column post-list"><section class="ui secondary top attached black segment post-head"><h1 class=post-title>Effective AWS CDK for AWS CloudFormation</h1><div class="sub header"><div><span><i class="calendar outline icon"></i>Dec 16, 2020</span></div><div><span><i class="clock outline icon"></i>4 min read</span></div><div><span><i class="angle double up icon"></i>Last updated on Jan 3, 2021</span></div></div><hr><article class="post-content twemoji"><p><a href=https://en.wikipedia.org/wiki/Infrastructure_as_code>Infrastructure as Code</a> is the trend to manage the resources of application. <a href=https://aws.amazon.com/cloudformation/>AWS CloudFormation</a> is the managed serive offering the IaC capability on AWS <a href=https://aws.amazon.com/blogs/aws/cloudformation-create-your-aws-stack-from-a-recipe/>since 2011</a>. CloudFormation uses the <a href=https://en.wikipedia.org/wiki/Declarative_programming>declarative language</a> to manage your AWS resources with the style what you get is what you declare.</p><p>However there are cons of CloudFormation as a declarative language,</p><ul><li>the readability and maintanence for applications involving lots of resources</li><li>the reuseable of code, <a href=https://aws.amazon.com/blogs/mt/introducing-aws-cloudformation-modules/>CloudFormation modules</a> released in re:Invent 2020 might help mitgate it</li></ul><p><a href=/posts/2019/aws-cdk/>AWS CDK</a> provides the programming way to define the infra in code by your preferred programming languages, such as Typescript, Javascripte, Python, Java and C#. AWS CDK will synthesis the code to CloudFormation template, then deploying the stack via AWS CloudForamtion service. It benefits the Devops engineers manage the infra on AWS as programming application, having version control, code review, unit testing, integration testing and CI/CD pipelines, the deployment still depends on the mature CloudFormation service to rolling update the resources and rollback when failing.</p><p>For solution development, using CDK indeed improves the productivity then publish the deployment assets as CloudFormation templates.</p><p>Though CDK application can be synthesized to CloudFormation template, there are still some differences blocking the synthesized tempaltes to be deployed across multiple AWS regeions.</p><p>This post will share the tips on how effectively writing AWS CDK application then deploying the application by CloudFormation across multiple regions.</p><h2 id=general>General&nbsp;<a class=anchor href=#general><i class="small linkify icon"></i></a></h2><h3 id=environment-agnostic-stack>Environment-agnostic stack&nbsp;<a class=anchor href=#environment-agnostic-stack><i class="small linkify icon"></i></a></h3><p>Donâ€™t specify env with <code>account</code> and <code>region</code> like below that will generate account/region hardcode in CloudFormation template.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MyStack</span>(<span style=color:#a6e22e>app</span>, <span style=color:#e6db74>&#39;Stack1&#39;</span>, {
    <span style=color:#a6e22e>env</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>account</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;123456789012&#39;</span>,
      <span style=color:#a6e22e>region</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;us-east-1&#39;</span>
    },
});
</code></pre></div><h3 id=use-cfnmappingcfncondition-instead-of-if-else-clause>use CfnMapping/CfnCondition instead of if-else clause&nbsp;<a class=anchor href=#use-cfnmappingcfncondition-instead-of-if-else-clause><i class="small linkify icon"></i></a></h3><p>CloudFormation does not have logistic processing like programming language. Use <code>CfnMapping</code> or <code>CfnCondition</code> instead.</p><p><strong>Note</strong>: the <code>CfnMapping</code> does not support default value, you have to list all supported regions like below code snippet,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#a6e22e>getAwsLoadBalancerControllerRepo() {</span>
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>albImageMapping</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>cdk</span>.<span style=color:#a6e22e>CfnMapping</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>&#39;ALBImageMapping&#39;</span>, {
      <span style=color:#a6e22e>mapping</span><span style=color:#f92672>:</span> {
        <span style=color:#e6db74>&#39;me-south-1&#39;</span><span style=color:#f92672>:</span> {
          <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;558608220178&#39;</span>,
        },
        <span style=color:#e6db74>&#39;eu-south-1&#39;</span><span style=color:#f92672>:</span> {
          <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;590381155156&#39;</span>,
        },
        <span style=color:#e6db74>&#39;ap-northeast-1&#39;</span><span style=color:#f92672>:</span> {
          <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;602401143452&#39;</span>,
        },
        <span style=color:#e6db74>&#39;ap-northeast-2&#39;</span><span style=color:#f92672>:</span> {
          <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;602401143452&#39;</span>,
        },
        ...        
        <span style=color:#e6db74>&#39;ap-east-1&#39;</span><span style=color:#f92672>:</span> {
          <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;800184023465&#39;</span>,
        },
        <span style=color:#e6db74>&#39;af-south-1&#39;</span><span style=color:#f92672>:</span> {
          <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;877085696533&#39;</span>,
        },
        <span style=color:#e6db74>&#39;cn-north-1&#39;</span><span style=color:#f92672>:</span> {
          <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;918309763551&#39;</span>,
        },
        <span style=color:#e6db74>&#39;cn-northwest-1&#39;</span><span style=color:#f92672>:</span> {
          <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;961992271922&#39;</span>,
        },
      }
    }); 
    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>albImageMapping</span>.<span style=color:#a6e22e>findInMap</span>(<span style=color:#a6e22e>cdk</span>.<span style=color:#a6e22e>Aws</span>.<span style=color:#a6e22e>REGION</span>, <span style=color:#e6db74>&#39;2&#39;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>.dkr.ecr.</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>cdk</span>.<span style=color:#a6e22e>Aws</span>.<span style=color:#a6e22e>REGION</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>cdk</span>.<span style=color:#a6e22e>Aws</span>.<span style=color:#a6e22e>URL_SUFFIX</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/amazon/aws-load-balancer-controller`</span>;
  }
</code></pre></div><h2 id=never-use-stackregion>never use Stack.region&nbsp;<a class=anchor href=#never-use-stackregion><i class="small linkify icon"></i></a></h2><p><strong>Donâ€™t</strong> rely on <code>stack.region</code> to do the logistic for China regions. Use additional <code>context</code> parameter or <code>CfnMapping</code> like below snippet,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>partitionMapping</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>cdk</span>.<span style=color:#a6e22e>CfnMapping</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>&#39;PartitionMapping&#39;</span>, {
    <span style=color:#a6e22e>mapping</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>aws</span><span style=color:#f92672>:</span> {
        <span style=color:#a6e22e>nexus</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;quay.io/travelaudience/docker-nexus&#39;</span>,
        <span style=color:#a6e22e>nexusProxy</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;quay.io/travelaudience/docker-nexus-proxy&#39;</span>,
      },
      <span style=color:#e6db74>&#39;aws-cn&#39;</span><span style=color:#f92672>:</span> {
        <span style=color:#a6e22e>nexus</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;048912060910.dkr.ecr.cn-northwest-1.amazonaws.com.cn/quay/travelaudience/docker-nexus&#39;</span>,
        <span style=color:#a6e22e>nexusProxy</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;048912060910.dkr.ecr.cn-northwest-1.amazonaws.com.cn/quay/travelaudience/docker-nexus-proxy&#39;</span>,
      },
    }
  });
<span style=color:#a6e22e>partitionMapping</span>.<span style=color:#a6e22e>findInMap</span>(<span style=color:#a6e22e>cdk</span>.<span style=color:#a6e22e>Aws</span>.<span style=color:#a6e22e>PARTITION</span>, <span style=color:#e6db74>&#39;nexus&#39;</span>);
</code></pre></div><p>Use <strong>core.Aws.region</strong> token refered to the region which region of the stack is deployed.</p><h3 id=explicitly-add-dependencies-on-resources-to-control-the-creationdeletion-order-of-resources>explicitly add dependencies on resources to control the creation/deletion order of resources&nbsp;<a class=anchor href=#explicitly-add-dependencies-on-resources-to-control-the-creationdeletion-order-of-resources><i class="small linkify icon"></i></a></h3><p>For example, when deploying a solution with creating a new VPC with NAT gateway, then deploying EMR cluster in private subnets of VPC. The EMR cluster might fail on creation due to network issue. Itâ€™s caused by the NAT gateway is not ready when initializing the EMR cluster, you have to manually create the dependencies among EMR cluster and NAT gateway.</p><h2 id=eks-moduleaws-cdkaws-eks>EKS module(@aws-cdk/aws-eks)&nbsp;<a class=anchor href=#eks-moduleaws-cdkaws-eks><i class="small linkify icon"></i></a></h2><h3 id=specify-kubectl-layer-when-creating-eks-cluster><del>specify kubectl layer when creating EKS cluster</del>&nbsp;<a class=anchor href=#specify-kubectl-layer-when-creating-eks-cluster><i class="small linkify icon"></i></a></h3><p><strong>NOTE</strong>: This tricky only applies for AWS CDK prior to <a href=https://github.com/aws/aws-cdk/releases/tag/v1.81.0>1.81.0</a>. CDK will <a href=https://github.com/aws/aws-cdk/pull/12129>bundle <code>kubectl</code>, <code>helm</code> and <code>awscli</code> as lambda layer</a> instead of SAR appliction since <a href=https://github.com/aws/aws-cdk/releases/tag/v1.81.0>1.81.0</a>, it resolves below limitation.</p><p>EKS uses a lambda layer to run <code>kubectl</code>/<code>helm</code> cli as custom resource, the <code>@aws-cdk/aws-eks</code> module depends on the <code>Stack.region</code> to check the region to be deployed in synthesizing phase. It violates the principle of Environment-agnostic stack! Use below workaround to create the EKS cluster,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>partitionMapping</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>cdk</span>.<span style=color:#a6e22e>CfnMapping</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>&#39;PartitionMapping&#39;</span>, {
  <span style=color:#a6e22e>mapping</span><span style=color:#f92672>:</span> {
    <span style=color:#a6e22e>aws</span><span style=color:#f92672>:</span> {
      <span style=color:#75715e>// see https://github.com/aws/aws-cdk/blob/60c782fe173449ebf912f509de7db6df89985915/packages/%40aws-cdk/aws-eks/lib/kubectl-layer.ts#L6
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>kubectlLayerAppid</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;arn:aws:serverlessrepo:us-east-1:903779448426:applications/lambda-layer-kubectl&#39;</span>,
    },
    <span style=color:#e6db74>&#39;aws-cn&#39;</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>kubectlLayerAppid</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;arn:aws-cn:serverlessrepo:cn-north-1:487369736442:applications/lambda-layer-kubectl&#39;</span>,
    },
  }
});

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>kubectlLayer</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>eks</span>.<span style=color:#a6e22e>KubectlLayer</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>&#39;KubeLayer&#39;</span>, {
  <span style=color:#a6e22e>applicationId</span>: <span style=color:#66d9ef>partitionMapping.findInMap</span>(<span style=color:#a6e22e>cdk</span>.<span style=color:#a6e22e>Aws</span>.<span style=color:#a6e22e>PARTITION</span>, <span style=color:#e6db74>&#39;kubectlLayerAppid&#39;</span>),
});
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cluster</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>eks</span>.<span style=color:#a6e22e>Cluster</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>&#39;MyK8SCluster&#39;</span>, {
  <span style=color:#a6e22e>vpc</span>,
  <span style=color:#a6e22e>defaultCapacity</span>: <span style=color:#66d9ef>0</span>,
  <span style=color:#a6e22e>kubectlEnabled</span>: <span style=color:#66d9ef>true</span>,
  <span style=color:#a6e22e>mastersRole</span>: <span style=color:#66d9ef>clusterAdmin</span>,
  <span style=color:#a6e22e>version</span>: <span style=color:#66d9ef>eks.KubernetesVersion.V1_16</span>,
  <span style=color:#a6e22e>coreDnsComputeType</span>: <span style=color:#66d9ef>eks.CoreDnsComputeType.EC2</span>,
  <span style=color:#a6e22e>kubectlLayer</span>,
});
</code></pre></div><p>If you&rsquo;re interested on this issue, <a href=https://github.com/aws/aws-cdk/issues/12018>see cdk issue for detail</a>.</p><h3 id=manage-the-lifecycle-of-helm-chart-deployment>manage the lifecycle of helm chart deployment&nbsp;<a class=anchor href=#manage-the-lifecycle-of-helm-chart-deployment><i class="small linkify icon"></i></a></h3><p>The k8s helm chart might create AWS resources out of CloudFormation scope. You have to manage the lifecycle of those resources by yourself.</p><p>For example, there is an EKS cluster with AWS load balancer controller, then you deploy a helm chart with ingress that will create ALB/NLB by the chart, you must clean those load balancers in deletion of the chart. Also the uninstallation of Helm chart is asynchronous, you have to watch the deletion of resource completing before continuing to clean other resources.</p><h2 id=the-end>THE END&nbsp;<a class=anchor href=#the-end><i class="small linkify icon"></i></a></h2><blockquote><p>The tips will be updated when something new is found or the one is deprecated after CDK is updated.</p><p>HAPPY CDK ğŸ˜†</p></blockquote></article></section><section class="ui secondary attached segment dream-tags"><a class="ui label red" href=/tags/infrastructure-as-code title="Infrastructure as Code">Infrastructure as Code</a>
<a class="ui label olive" href=/tags/aws-cloudformation title="AWS CloudFormation">AWS CloudFormation</a>
<a class="ui label orange" href=/tags/aws-cdk title="AWS CDK">AWS CDK</a>
<a class="ui label olive" href=/tags/aws title=AWS>AWS</a></section><section class="ui secondary bottom attached segment share row box"><div class=author><img class=avatar src=/img/portrait.jpg></div><div class="info grow flexbox"><p class=name>Kane</p><p class=desc>Three boys' father, open source mania.</p></div><section class="buttons row box"><div class="facebook none flexbox" href=# onclick="window.open('https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),'facebook-share-dialog','width=626,height=436');return false;"><button class="ui facebook button"><i class="facebook icon"></i>Share</button></div><div class="twitter none flexbox" onclick="window.open('https://twitter.com/intent/tweet?text=Read &#34;Effective AWS CDK for AWS CloudFormation  https:\/\/kane.mx\/posts\/2020\/effective-aws-cdk-for-aws-cloudformation\/','_self')"><button class="ui twitter button"><i class="twitter icon"></i>Tweet</button></div></section></section><script src=https://utteranc.es/client.js repo=zxkane/articles issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div></div><div class=back><nav class="ui top secondary menu bar"><div class=item><i class="inverted big link bullseye icon dream-flip-toggle" title="About Me"></i></div><div class=item><a href=https://github.com/zxkane target=_blank><i id=ico class="inverted big link github icon" title=GitHub></i></a></div><div class=item><a href=mailto:me@kane.mx target=_blank><i id=ico class="inverted big link mail icon" title=Email></i></a></div><div class=item><a href=https://www.stackoverflow.com/users/390513/kane target=_blank><i id=ico class="inverted big link stack overflow icon" title="Stack Overflow"></i></a></div></nav><div class="ui centered grid about"><div class="sixteen wide mobile fifteen wide tablet fifteen wide computer column about"><section class="ui stacked segments"><div class="ui inverted segment"><article class=twemoji><h1 id=so-who-am-i>So, Who Am I?</h1><hr><p>Iâ€™m the father of three boys. Live in Beijing. Also I&rsquo;m the *uix user, a full stack software engineer, devops and cloud native evangelist.</p><p>Curious about me? Use the social links above to check out my profiles.</p></article></div></section></div></div></div></div></div><script src=/js/site.js></script><script src=https://twemoji.maxcdn.com/2/twemoji.min.js?2.6></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-11561366-2','auto');ga('send','pageview');</script><script async src=https://www.google-analytics.com/analytics.js></script><script>(function(){console.log("Twemoji up and making stuff colourful!");for(var b=document.getElementsByClassName("twemoji"),a=0;a<b.length;a++){twemoji.parse(b[a]);}})();</script></body></html>